@model PagoPrestamoViewModel
@{
    ViewData["Title"] = "Pago de Préstamo";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Pago de Préstamo</h3>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["SuccessMessage"]
                        </div>
                    }

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Información del Cajero</h5>
                            <p><strong>Ubicación:</strong> @ViewBag.CajeroUbicacion</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Información de la Cuenta</h5>
                            <p><strong>Saldo Disponible:</strong> @ViewBag.SaldoDisponible</p>
                        </div>
                    </div>

                    <form id="pagoForm" asp-action="PagoPrestamo" method="post">
                        <input type="hidden" asp-for="CodigoCajero" />
                        <input type="hidden" asp-for="Numerotarjeta" />
                        <input type="hidden" asp-for="tarjetaCodigoCaja" />
                        <input type="hidden" asp-for="CodigoTitular" />
                        <div class="form-group">
                            <label asp-for="CodigoPrestamo">Número de Préstamo</label>
                            <input asp-for="CodigoPrestamo" class="form-control" autocomplete="off" />
                            <span asp-validation-for="CodigoPrestamo" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Monto">Monto a Pagar</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="Monto" class="form-control" autocomplete="off" />
                            </div>
                            <span asp-validation-for="Monto" class="text-danger"></span>
                        </div>

                        <div class="form-group mt-4">
                            <button type="button" id="confirmarPagoBtn" class="btn btn-primary w-100">
                                <i class="fas fa-money-bill-wave"></i> Realizar Pago
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.CodigoCajero"
                                asp-route-tarjetaCodigoCaja="@Model.tarjetaCodigoCaja"
                                class="btn btn-secondary w-100 mt-2">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmacionModal" tabindex="-1" aria-labelledby="confirmacionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmacionModalLabel">Confirmar Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea realizar un pago de <strong>$<span id="montoConfirmacion"></span></strong> al
                    préstamo <strong><span id="prestamoConfirmacion"></span></strong>?</p>
                <p>Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmarModalBtn" class="btn btn-primary">Confirmar Pago</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            // Solo permitir números y puntos en el monto
            $('#Monto').on('input', function () {
                this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
            });

            // Mostrar error global (por ejemplo desde el controlador)
            @if (ViewContext.ModelState.ContainsKey("") && ViewContext.ModelState[""].Errors.Any())
                {
                    <text>
                        toastr.error('@ViewContext.ModelState[""].Errors.First().ErrorMessage');
                    </text>
            }

                // Mostrar modal de confirmación
                $('#confirmarPagoBtn').click(function (e) {
                    e.preventDefault();

                    if ($('#pagoForm').valid()) {
                        $('#montoConfirmacion').text($('#Monto').val());
                        $('#prestamoConfirmacion').text($('#CodigoPrestamo').val());
                        $('#confirmacionModal').modal('show');
                    }
                });

            // Confirmar el pago desde el modal
            $('#confirmarModalBtn').click(function () {
                $('#confirmacionModal').modal('hide');
                $('#pagoForm').submit();
            });
        });
    </script>
}
